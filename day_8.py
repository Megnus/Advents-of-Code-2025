import aoc
import sys
import math

data = aoc.get_data(True)
data = [tuple(int(i) for i in d.split(',')) for d in data]


def get_this(connection):
	for i, row in enumerate(connection):
		for e in row:
			for j, raw in enumerate(connection):
				if i >= j:
					continue
				if e in raw:
					return i, j
	return -1, -1


def get_all_connections():
	connections = set()
	for A in data:
		for B in data:
			if A != B:
				C = tuple(sorted((A, B)))
				connections.add(C)
	return sorted(connections)

def get_all_connection_distances(connections):
	con_distance = list()
	for connection in connections:
		A, B = connection
		a, b, c = A
		d, e, f = B
		distance = (a - d)**2 + (b - e)**2 + (c - f)**2
		con_distance.append((*connection, distance))

	con_distance = sorted(con_distance, key=lambda x: x[2])

	return list((A, B) for A, B, _ in con_distance)


def mege_recursive(clusters):
	for cluster in clusters:
		# cluster = {(162, 817, 812), (425, 690, 689)}
		for c in cluster:
			# c = (162, 817, 812)
			# cluster
			for sub_cluster in clusters:
				if cluster != sub_cluster:
					if c in sub_cluster:
						# print(cluster, sub_cluster)
						clusters.remove(cluster)
						clusters.remove(sub_cluster)
						clusters.append(cluster.union(sub_cluster))
						return mege_recursive(clusters)
	return clusters


def mege_without_recursion(connections):
# 	999 6277
# 1000 6278
# ((86005, 23974, 12506), (97906, 28543, 4213))
# 8420405530
	print(86005*97906)
	for num in range(6277, len(connections)):
		sub_connections = connections[:num]
		clusters = [set(c) for c in sub_connections]

		# print(clusters)
		# for q in clusters:
		# 	print(q)
		# exit()
		restart = True
		while restart:
			restart = False
			for i, cluster in enumerate(clusters):
				for c in cluster:
					# c = (162, 817, 812)
					# cluster
					# print('*', len(clusters))
					for j, sub_cluster in enumerate(clusters):
						if i != j and c in sub_cluster:
							clusters.remove(cluster)
							clusters.remove(sub_cluster)
							clusters.append(cluster.union(sub_cluster))
							restart = True
							break
					if restart:
						break
				if restart:
					break
		print(len(clusters[0]), num)
		if len(clusters[0]) == len(data):
			print(connections[num - 1])
			A, B = connections[num - 1]
			x1, _, _ = A
			x2, _, _ = B
			print(x1 * x2)
			break

	return clusters


def part_1():
	connections = get_all_connections()
	connections = get_all_connection_distances(connections)
	clusters = [set(c) for c in connections]
	clusters = mege_recursive(clusters[:1000])
	length_clusters = sorted([len(c) for c in clusters], reverse=True)
	top_three = length_clusters[:3]
	return math.prod(top_three[:3])


def part_2():
	connections = get_all_connections()
	connections = get_all_connection_distances(connections)
	mege_without_recursion(connections)

	exit()
	connection_clusters = [set(c) for c in connections]
	# for c in clusters:
	# 	print(c)
	# last_connection = 28
	print(len(connection_clusters))
	# exit()
	for last_connection, _ in enumerate(connection_clusters):
		last_connection += 1200
		clusters = connection_clusters.copy()
		clusters = mege_recursive(clusters[:last_connection + 1])
		# print(len(clusters[0]), len(data))
		print(last_connection, len(clusters[0]), len(data))
		if len(clusters[0]) == len(data):
			print(connections[last_connection])
			break

	# for i, c in enumerate(clusters):
	# 	print(i + 1, c)
	return None


# print('part 1:', part_1())
print('part 2:', part_2())

# 9240 to low


"""
{(162, 817, 812), (425, 690, 689)}
{(162, 817, 812), (431, 825, 988)}
{(906, 360, 560), (805, 96, 715)}
{(431, 825, 988), (425, 690, 689)}
{(862, 61, 35), (984, 92, 344)}
{(52, 470, 668), (117, 168, 530)}
{(941, 993, 340), (819, 987, 18)}
{(739, 650, 466), (906, 360, 560)}
{(425, 690, 689), (346, 949, 466)}
{(906, 360, 560), (984, 92, 344)}
{(592, 479, 940), (425, 690, 689)}
{(542, 29, 236), (352, 342, 300)}
{(117, 168, 530), (352, 342, 300)}
{(466, 668, 158), (352, 342, 300)}
{(542, 29, 236), (862, 61, 35)}
{(431, 825, 988), (592, 479, 940)}
{(739, 650, 466), (425, 690, 689)}
{(52, 470, 668), (162, 817, 812)}
{(970, 615, 88), (819, 987, 18)}
{(805, 96, 715), (984, 92, 344)}
{(739, 650, 466), (466, 668, 158)}
{(162, 817, 812), (346, 949, 466)}
{(739, 650, 466), (941, 993, 340)}
{(57, 618, 57), (466, 668, 158)}
{(52, 470, 668), (425, 690, 689)}
{(466, 668, 158), (346, 949, 466)}
{(739, 650, 466), (970, 615, 88)}
{(970, 615, 88), (941, 993, 340)}
{(117, 168, 530), (216, 146, 977)}

{(542, 29, 236), (984, 92, 344)}
{(57, 618, 57), (352, 342, 300)}
{(52, 470, 668), (216, 146, 977)}
{(52, 470, 668), (352, 342, 300)}
{(592, 479, 940), (805, 96, 715)}
{(739, 650, 466), (346, 949, 466)}
{(466, 668, 158), (819, 987, 18)}
{(592, 479, 940), (216, 146, 977)}
{(906, 360, 560), (592, 479, 940)}
{(970, 615, 88), (466, 668, 158)}
{(739, 650, 466), (352, 342, 300)}
{(739, 650, 466), (592, 479, 940)}
{(425, 690, 689), (352, 342, 300)}
{(425, 690, 689), (466, 668, 158)}
{(542, 29, 236), (117, 168, 530)}
{(906, 360, 560), (970, 615, 88)}
{(431, 825, 988), (346, 949, 466)}
{(542, 29, 236), (805, 96, 715)}
{(162, 817, 812), (592, 479, 940)}
{(739, 650, 466), (819, 987, 18)}
{(970, 615, 88), (862, 61, 35)}
{(970, 615, 88), (984, 92, 344)}
{(542, 29, 236), (906, 360, 560)}
{(52, 470, 668), (346, 949, 466)}
{(906, 360, 560), (425, 690, 689)}
{(57, 618, 57), (346, 949, 466)}
{(466, 668, 158), (941, 993, 340)}
{(52, 470, 668), (592, 479, 940)}
{(906, 360, 560), (862, 61, 35)}
{(346, 949, 466), (941, 993, 340)}
{(52, 470, 668), (431, 825, 988)}
{(739, 650, 466), (805, 96, 715)}
{(906, 360, 560), (352, 342, 300)}
{(739, 650, 466), (984, 92, 344)}
{(117, 168, 530), (425, 690, 689)}
{(57, 618, 57), (52, 470, 668)}
{(352, 342, 300), (346, 949, 466)}
{(739, 650, 466), (431, 825, 988)}
{(862, 61, 35), (352, 342, 300)}
{(216, 146, 977), (805, 96, 715)}
{(542, 29, 236), (466, 668, 158)}
{(425, 690, 689), (216, 146, 977)}
{(346, 949, 466), (819, 987, 18)}
{(57, 618, 57), (117, 168, 530)}
{(805, 96, 715), (352, 342, 300)}
{(906, 360, 560), (466, 668, 158)}
{(906, 360, 560), (941, 993, 340)}
{(352, 342, 300), (984, 92, 344)}
{(805, 96, 715), (862, 61, 35)}
{(52, 470, 668), (466, 668, 158)}
{(542, 29, 236), (739, 650, 466)}
{(425, 690, 689), (941, 993, 340)}
{(162, 817, 812), (216, 146, 977)}
{(739, 650, 466), (162, 817, 812)}
{(592, 479, 940), (352, 342, 300)}
{(117, 168, 530), (592, 479, 940)}
{(425, 690, 689), (805, 96, 715)}
{(970, 615, 88), (352, 342, 300)}
{(117, 168, 530), (162, 817, 812)}
{(592, 479, 940), (346, 949, 466)}
{(431, 825, 988), (216, 146, 977)}
{(117, 168, 530), (466, 668, 158)}
{(117, 168, 530), (805, 96, 715)}
{(216, 146, 977), (352, 342, 300)}
{(162, 817, 812), (352, 342, 300)}
{(57, 618, 57), (425, 690, 689)}
{(862, 61, 35), (466, 668, 158)}
{(162, 817, 812), (466, 668, 158)}
{(739, 650, 466), (52, 470, 668)}
{(739, 650, 466), (862, 61, 35)}
{(542, 29, 236), (970, 615, 88)}
{(57, 618, 57), (542, 29, 236)}
{(57, 618, 57), (162, 817, 812)}
{(542, 29, 236), (52, 470, 668)}
{(739, 650, 466), (117, 168, 530)}
{(431, 825, 988), (906, 360, 560)}
{(57, 618, 57), (739, 650, 466)}
{(466, 668, 158), (984, 92, 344)}
{(970, 615, 88), (346, 949, 466)}
{(542, 29, 236), (425, 690, 689)}
{(592, 479, 940), (984, 92, 344)}
{(117, 168, 530), (906, 360, 560)}
{(592, 479, 940), (466, 668, 158)}
{(425, 690, 689), (970, 615, 88)}
{(117, 168, 530), (346, 949, 466)}
{(542, 29, 236), (216, 146, 977)}
{(906, 360, 560), (346, 949, 466)}
{(805, 96, 715), (970, 615, 88)}
{(425, 690, 689), (819, 987, 18)}
{(906, 360, 560), (819, 987, 18)}
{(906, 360, 560), (216, 146, 977)}
{(542, 29, 236), (592, 479, 940)}
{(431, 825, 988), (941, 993, 340)}
{(52, 470, 668), (805, 96, 715)}
{(431, 825, 988), (352, 342, 300)}
{(352, 342, 300), (819, 987, 18)}
{(431, 825, 988), (466, 668, 158)}
{(57, 618, 57), (819, 987, 18)}
{(117, 168, 530), (431, 825, 988)}
{(431, 825, 988), (805, 96, 715)}
{(592, 479, 940), (941, 993, 340)}
{(805, 96, 715), (466, 668, 158)}
{(52, 470, 668), (906, 360, 560)}
{(352, 342, 300), (941, 993, 340)}
{(739, 650, 466), (216, 146, 977)}
{(425, 690, 689), (984, 92, 344)}
{(117, 168, 530), (984, 92, 344)}
{(117, 168, 530), (862, 61, 35)}
{(984, 92, 344), (941, 993, 340)}
{(162, 817, 812), (906, 360, 560)}
{(57, 618, 57), (970, 615, 88)}
{(862, 61, 35), (819, 987, 18)}
{(162, 817, 812), (941, 993, 340)}
{(592, 479, 940), (970, 615, 88)}
{(216, 146, 977), (346, 949, 466)}
{(984, 92, 344), (819, 987, 18)}
{(542, 29, 236), (346, 949, 466)}
{(162, 817, 812), (805, 96, 715)}
{(57, 618, 57), (862, 61, 35)}
{(805, 96, 715), (941, 993, 340)}
{(862, 61, 35), (941, 993, 340)}
{(216, 146, 977), (984, 92, 344)}
{(805, 96, 715), (346, 949, 466)}
{(57, 618, 57), (941, 993, 340)}
{(216, 146, 977), (466, 668, 158)}
{(425, 690, 689), (862, 61, 35)}
{(57, 618, 57), (906, 360, 560)}
{(542, 29, 236), (819, 987, 18)}
{(57, 618, 57), (431, 825, 988)}
{(592, 479, 940), (862, 61, 35)}
{(57, 618, 57), (592, 479, 940)}
{(162, 817, 812), (819, 987, 18)}
{(57, 618, 57), (216, 146, 977)}
{(542, 29, 236), (162, 817, 812)}
{(542, 29, 236), (941, 993, 340)}
{(52, 470, 668), (984, 92, 344)}
{(431, 825, 988), (819, 987, 18)}
{(117, 168, 530), (970, 615, 88)}
{(431, 825, 988), (970, 615, 88)}
{(346, 949, 466), (984, 92, 344)}
{(592, 479, 940), (819, 987, 18)}
{(52, 470, 668), (941, 993, 340)}
{(52, 470, 668), (970, 615, 88)}
{(542, 29, 236), (431, 825, 988)}
{(162, 817, 812), (970, 615, 88)}
{(57, 618, 57), (984, 92, 344)}
{(52, 470, 668), (862, 61, 35)}
{(862, 61, 35), (346, 949, 466)}
{(431, 825, 988), (984, 92, 344)}
{(57, 618, 57), (805, 96, 715)}
{(52, 470, 668), (819, 987, 18)}
{(805, 96, 715), (819, 987, 18)}
{(216, 146, 977), (862, 61, 35)}
{(117, 168, 530), (941, 993, 340)}
{(162, 817, 812), (984, 92, 344)}
{(117, 168, 530), (819, 987, 18)}
{(216, 146, 977), (970, 615, 88)}
{(216, 146, 977), (941, 993, 340)}
{(162, 817, 812), (862, 61, 35)}
{(431, 825, 988), (862, 61, 35)}
{(216, 146, 977), (819, 987, 18)}
[Finished in 0.3s]
"""